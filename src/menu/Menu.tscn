[gd_scene load_steps=5 format=2]

[ext_resource path="res://src/menu/OptionChooser.tscn" type="PackedScene" id=2]
[ext_resource path="res://src/menu/PlayButtonFont.tres" type="DynamicFont" id=3]
[ext_resource path="res://src/menu/GameTitleFont.tres" type="DynamicFont" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Control

onready var PlayButtonFont = preload(\"res://src/menu/PlayButtonFont.tres\")
onready var GameTitleFont = preload(\"res://src/menu/GameTitleFont.tres\")

var _main

const SPEED_ARRAY: Array = [\"very slow\", \"slow\", \"normal\", \"fast\", \"very fast\"]
const SPEED_DEFAULT_INDEX: int = 2
const SKINS_ARRAY: Array = [\"simple\", \"debug\", \"kawaii\"]
const SKINS_DEFAULT_INDEX: int = 0
const CONTROLS_ARRAY: Array = [\"Arrow\", \"Split\", \"Swipe\"]
const CONTROLS_DEFAULT_INDEX: int = 2
const GAME_TITLE_DEFAULT_FONT_SIZE: int = 40
const PLAY_BUTTON_DEFAULT_FONT_SIZE: int = 28

func _ready():
	var scale = _get_scale()
	GameTitleFont.size = _get_int_font_size(GAME_TITLE_DEFAULT_FONT_SIZE, scale)
	PlayButtonFont.size = _get_int_font_size(PLAY_BUTTON_DEFAULT_FONT_SIZE, scale)
	$GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/SpeedOptionChooser.fill(
		\"Speed\", SPEED_ARRAY, SPEED_DEFAULT_INDEX
	)
	$GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/SpeedOptionChooser.scale_font(scale)
	$GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/SkinOptionChooser.fill(
		\"Skin\", SKINS_ARRAY, SKINS_DEFAULT_INDEX
	)
	$GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/SkinOptionChooser.scale_font(scale)
	$GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/StageOptionChooser.fill(
		\"Stage\", _list_available_stages(\"res://assets/stages\"), 0
	)
	$GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/StageOptionChooser.scale_font(scale)
	$GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/ControlsOptionChooser.fill(
		\"Controls\", CONTROLS_ARRAY, CONTROLS_DEFAULT_INDEX
	)
	$GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/ControlsOptionChooser.scale_font(scale)

func _get_int_font_size(default_value: int, scale: float) -> int:
	return int(floor(default_value * scale))

func set_main(main) -> void:
	_main = main

func _get_scale() -> float:
	var project_height = ProjectSettings.get(\"display/window/size/height\")
	var project_width = ProjectSettings.get(\"display/window/size/width\")
	var original_ratio = project_height / project_width
	var screen_size = get_tree().get_root().size
	var runtime_ratio = screen_size.y / screen_size.x
	if runtime_ratio >= original_ratio:
		return screen_size.x / project_width
	else:
		return screen_size.y / project_height

func _on_PlayButton_pressed():
	var difficulty_settings: DifficultySettings
	match $GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/SpeedOptionChooser.get_selected_index():
		0: difficulty_settings = DifficultySettings.new(12, 0.6, 0.992)
		1: difficulty_settings = DifficultySettings.new(10, 0.55, 0.991)
		2: difficulty_settings = DifficultySettings.new(7, 0.5, 0.99)
		3: difficulty_settings = DifficultySettings.new(5, 0.45, 0.989)
		4: difficulty_settings = DifficultySettings.new(3, 0.4, 0.988)
	var selected_skin = str(
		\"res://assets/skins/\", $GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/SkinOptionChooser.get_selected_option()
	)
	var stage_name = $GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/StageOptionChooser.get_selected_option()
	var parsed_stage: ParsedStage = JsonStageParser.parse(str(
		\"res://assets/stages/\", stage_name, \".json\"
	))
	var selected_controls: String = $GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/ControlsOptionChooser.get_selected_option()
	_main.play(parsed_stage, difficulty_settings, selected_skin, selected_controls)

func _list_available_stages(path: String) -> Array:
	var files = _list_files_in_directory(path)
	var res = []
	for f in files:
		res.push_back(f.replace(\".json\", \"\"))
	return res

func _list_files_in_directory(path):
	var files = []
	var dir = Directory.new()
	dir.open(path)
	dir.list_dir_begin()

	while true:
		var file = dir.get_next()
		if file == \"\":
			break
		elif not file.begins_with(\".\"):
			files.append(file)

	dir.list_dir_end()

	return files
"

[node name="Menu" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource( 1 )

[node name="ColorRect" type="ColorRect" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
color = Color( 0.784314, 0.984314, 0.913725, 1 )

[node name="GuiAreaControl" type="Control" parent="."]
anchor_left = 0.03
anchor_top = 0.03
anchor_right = 0.97
anchor_bottom = 0.99

[node name="RectangleAspectRatioContainer" type="AspectRatioContainer" parent="GuiAreaControl"]
anchor_right = 1.0
anchor_bottom = 1.0
ratio = 0.489

[node name="RectangleControl" type="Control" parent="GuiAreaControl/RectangleAspectRatioContainer"]
margin_left = 0.167999
margin_right = 281.832
margin_bottom = 576.0

[node name="GameTitleLabel" type="Label" parent="GuiAreaControl/RectangleAspectRatioContainer/RectangleControl"]
anchor_right = 1.0
anchor_bottom = 0.1
margin_right = 0.335999
custom_colors/font_color = Color( 0, 0, 0, 1 )
custom_fonts/font = ExtResource( 4 )
text = "Snake ++"
align = 1
valign = 1

[node name="SpeedOptionChooser" parent="GuiAreaControl/RectangleAspectRatioContainer/RectangleControl" instance=ExtResource( 2 )]
anchor_top = 0.152
anchor_bottom = 0.3

[node name="SkinOptionChooser" parent="GuiAreaControl/RectangleAspectRatioContainer/RectangleControl" instance=ExtResource( 2 )]
anchor_top = 0.339
anchor_bottom = 0.487

[node name="StageOptionChooser" parent="GuiAreaControl/RectangleAspectRatioContainer/RectangleControl" instance=ExtResource( 2 )]
anchor_top = 0.526
anchor_bottom = 0.674
margin_bottom = 0.0

[node name="ControlsOptionChooser" parent="GuiAreaControl/RectangleAspectRatioContainer/RectangleControl" instance=ExtResource( 2 )]
anchor_top = 0.713
anchor_bottom = 0.861

[node name="PlayButton" type="Button" parent="GuiAreaControl/RectangleAspectRatioContainer/RectangleControl"]
anchor_top = 0.9
anchor_right = 1.0
anchor_bottom = 1.0
custom_fonts/font = ExtResource( 3 )
text = "Play"

[connection signal="pressed" from="GuiAreaControl/RectangleAspectRatioContainer/RectangleControl/PlayButton" to="." method="_on_PlayButton_pressed"]
